@use "sass:string";
@use "@db-ux/core-foundations/build/styles/variables";
@use "@db-ux/core-foundations/build/styles/helpers";
@use "@db-ux/core-foundations/build/styles/colors";
@use "@db-ux/core-foundations/build/styles/screen-sizes";
@use "./form-components";
@use "./custom-elements";
@use "./component";
@use "./navigation-item";
@use "./db-puls";
@use "./scrollbar";

$navigation-child-selector: "> .db-control-panel-desktop-scroll-container > .db-navigation, > .db-control-panel-desktop-scroll-container > db-navigation > .db-navigation";
$meta-child-selector: "> .db-control-panel-desktop-scroll-container  .db-control-panel-meta-navigation";

@mixin navigation-child {
	#{string.unquote($navigation-child-selector)} {
		@content;
	}
}

@mixin horizontal-navigation($scroll-buttons: true) {
	@if ($scroll-buttons) {
		@include scrollbar.set-overflow-scroll-buttons;

		&:has(.overflow-scroll-left-button) {
			> menu {
				&::before {
					content: "";
				}
			}
		}

		&:has(.overflow-scroll-right-button) {
			> menu {
				&::after {
					content: "";
				}
			}
		}
	}

	&:has(.db-button) {
		> menu {
			@if ($scroll-buttons) {
				@include scrollbar.set-overflow-scroll-button-backgrounds;
			}

			@supports (scrollbar-width: none) {
				scrollbar-width: none;
			}

			&::-webkit-scrollbar {
				display: none;
			}

			&::before,
			&::after {
				block-size: calc(100% - #{variables.$db-border-width-3xs});
				inset-block: 0;
				flex: none;
			}
		}
	}

	> menu {
		overflow: auto hidden;
		scrollbar-gutter: stable both-edges;
		flex-direction: row;

		#{string.unquote(custom-elements.$navigation-item-group)} {
			&:is(button),
			> button {
				&::after {
					--db-icon-after: "chevron_down";
				}
			}

			> .db-navigation-item-group-menu {
				inset-block-start: calc(
					100% +
						var(
							--db-navigation-item-group-menu-inset-block-start,
							#{variables.$db-spacing-fixed-md}
						)
				);

				&::before {
					content: "";
					position: absolute;
					inset-inline-start: 0;
					inline-size: 100%;
					// #{$db-spacing-fixed--3xs} for shadows
					block-size: calc(
						#{variables.$db-spacing-fixed-3xs} +
							#{variables.$db-spacing-fixed-md}
					);
					inset-block-start: calc(
						-1 * #{variables.$db-spacing-fixed-md} -
							#{variables.$db-spacing-fixed-3xs}
					);
				}
			}
		}
	}
}

@mixin vertical-navigation {
	padding-block: variables.$db-spacing-fixed-md;

	> .overflow-scroll-left-button,
	> .overflow-scroll-right-button {
		display: none;
	}

	&:not([data-variant]),
	&[data-variant="popover"] {
		> menu {
			.db-navigation-item-group {
				.db-navigation-item-group-menu {
					inset-inline-start: calc(
						100% + #{variables.$db-spacing-fixed-md}
					);

					@include navigation-item.navigation-item-group-menu-triangle-vertical;
				}
			}
		}
	}

	> menu {
		flex-direction: column;
		padding-inline: variables.$db-spacing-fixed-lg;
	}
}

%control-panel-desktop-horizontal-orientation {
	border-block-end: variables.$db-border-width-3xs solid
		colors.$db-adaptive-on-bg-basic-emphasis-60-default;
	grid-template:
		[meta]
		"meta meta meta meta meta meta" auto
		[padding-top]
		". . navigation . . ." #{variables.$db-spacing-fixed-md}
		[others]
		". brand navigation primary secondary ." auto
		[padding-bottom]
		". . navigation . . ." #{variables.$db-spacing-fixed-md} /
		[padding-left] #{variables.$db-spacing-fixed-lg}
		[brand] max-content
		[navigation] 1fr
		[primary] max-content
		[secondary] max-content
		[padding-right] #{variables.$db-spacing-fixed-lg};

	> .db-control-panel-desktop-scroll-container {
		display: contents;
	}

	#{string.unquote(custom-elements.$control-panel-brand)} {
		padding-inline-end: variables.$db-spacing-fixed-lg;
	}

	#{string.unquote(custom-elements.$control-primary-actions)},
	#{string.unquote(custom-elements.$control-secondary-actions)} {
		block-size: variables.$db-sizing-md;
	}

	#{string.unquote(custom-elements.$control-primary-actions)} {
		margin-inline-start: variables.$db-spacing-fixed-sm;
	}

	> .db-control-panel-desktop-button {
		display: none;
	}

	&:has(
			#{string.unquote(custom-elements.$control-primary-actions)},
			#{string.unquote($navigation-child-selector)}
		) {
		#{string.unquote(custom-elements.$control-secondary-actions)} {
			padding-inline-start: variables.$db-spacing-fixed-sm;

			@include helpers.divider("left");
		}
	}

	&:has(#{string.unquote($navigation-child-selector)}) {
		#{string.unquote(custom-elements.$control-panel-brand)} {
			@include helpers.divider("right", "after");
		}
	}

	&:has(#{string.unquote(custom-elements.$control-secondary-actions)}) {
		#{string.unquote(custom-elements.$control-primary-actions)} {
			margin-inline-end: variables.$db-spacing-fixed-sm;
		}
	}

	&[data-width="small"] {
		margin-inline: auto;
		max-inline-size: screen-sizes.$db-breakpoint-sm;
	}

	&[data-width="medium"] {
		margin-inline: auto;
		max-inline-size: screen-sizes.$db-breakpoint-md;
	}

	&[data-width="large"] {
		margin-inline: auto;
		max-inline-size: screen-sizes.$db-breakpoint-lg;
	}

	@include navigation-child {
		--db-overflow-scroll-button-inset-block: #{variables.$db-spacing-fixed-md};
		--db-overflow-scroll-button-inset-inline-start: calc(
			#{variables.$db-spacing-fixed-lg} / 2
		);

		display: grid;

		@include horizontal-navigation;

		> menu {
			padding-block: variables.$db-spacing-fixed-md;

			/* workaround for showing correct scrolling and focus */
			padding-inline-start: calc(#{variables.$db-spacing-fixed-lg} / 2);
			margin-inline-start: calc(#{variables.$db-spacing-fixed-lg} / 2);

			@include navigation-item.direct-navigation-items {
				@extend %db-puls;

				@include db-puls.set-db-puls-horizontal();

				@include navigation-item.active-navigation-item {
					@include db-puls.show-db-puls-horizontal();
				}

				@include navigation-item.direct-navigation-items {
					/* Workaround for custom-elements */
					&::after {
						content: none;
					}
				}
			}
		}
	}
}

%control-panel-desktop-vertical-orientation {
	border-inline-end: variables.$db-border-width-3xs solid
		colors.$db-adaptive-on-bg-basic-emphasis-60-default;
	block-size: 100%;
	grid-template:
		[padding-top] "." #{variables.$db-spacing-fixed-md}
		[brand] "brand" auto
		[scroll] "scroll" 1fr
		[primary] "primary" auto
		[secondary] "secondary" auto
		[button] "button" auto;

	@media screen and (prefers-reduced-motion: no-preference) {
		transition: inline-size #{variables.$db-transition-straight-functional};

		> .db-control-panel-desktop-button {
			.db-button {
				@media screen and (prefers-reduced-motion: reduce) {
					&::before {
						transition: none;
					}
				}

				&::before {
					transition: transform
						#{variables.$db-transition-straight-functional};
				}
			}
		}
	}

	&[data-open="false"] {
		inline-size: auto;
		/* stylelint-disable-next-line declaration-property-value-no-unknown */
		inline-size: calc-size(auto, size);

		#{string.unquote(custom-elements.$control-primary-actions)},
		#{string.unquote(custom-elements.$control-secondary-actions)},
		#{string.unquote($meta-child-selector)} {
			display: none;
		}

		@include navigation-child {
			> menu {
				@include navigation-item.direct-navigation-items {
					--db-icon-margin-end: 0;

					inline-size: variables.$db-sizing-md;
					aspect-ratio: 1;
					justify-content: center;
					align-items: center;

					&::before {
						position: initial;
					}

					a {
						font-size: 0;
						position: absolute;
						inset: 0;
					}
				}

				#{string.unquote(custom-elements.$navigation-item)} {
					.db-tooltip {
						// We show tooltip for collapsed state
						--db-show-popover-visibility: visible;
					}
				}
			}
		}

		&:has(
				#{string.unquote($navigation-child-selector)}
					> menu
					#{string.unquote(custom-elements.$navigation-item-group)}
			) {
			#{string.unquote($navigation-child-selector)} {
				display: none;
			}

			#{string.unquote(custom-elements.$control-panel-brand)} {
				&::after {
					display: none;
				}
			}
		}

		#{string.unquote(custom-elements.$control-panel-brand)} {
			font-size: 0;
			gap: 0;
			place-self: center;
		}

		> .db-control-panel-desktop-button {
			justify-content: center;

			.db-button {
				&::before {
					transform: form-components.$dropdown-icon-transform;
				}
			}
		}
	}

	&[data-open="true"] {
		inline-size: var(
			--db-control-panel-desktop-inline-size,
			#{screen-sizes.$db-breakpoint-xs}
		);
	}

	> .db-control-panel-desktop-button {
		grid-area: button;
		padding-block: variables.$db-spacing-fixed-xs;
		display: flex;
		justify-content: end;

		@include helpers.divider("top");
	}

	#{string.unquote(custom-elements.$control-panel-brand)},
	#{string.unquote(custom-elements.$control-primary-actions)},
	#{string.unquote(custom-elements.$control-secondary-actions)},
	> .db-control-panel-desktop-button {
		padding-inline: variables.$db-spacing-fixed-lg;
	}

	#{string.unquote(custom-elements.$control-panel-brand)},
	#{string.unquote(custom-elements.$control-primary-actions)},
	#{string.unquote(custom-elements.$control-secondary-actions)} {
		margin-block-end: variables.$db-spacing-fixed-md;
	}

	> .db-control-panel-desktop-scroll-container {
		display: grid;
		overflow: hidden auto;
		grid-area: scroll;
		grid-template-areas: "navigation" "meta";

		#{string.unquote(custom-elements.$control-meta-navigation)} {
			margin-block-start: auto;

			@include helpers.divider("top");
		}
	}

	&:has(
			#{string.unquote(custom-elements.$control-panel-brand)},
			#{string.unquote(custom-elements.$control-primary-actions)},
			#{string.unquote($navigation-child-selector)},
			#{string.unquote($meta-child-selector)}
		) {
		#{string.unquote(custom-elements.$control-secondary-actions)} {
			padding-block-start: variables.$db-spacing-fixed-sm;

			@include helpers.divider("top");
		}
	}

	&:has(#{string.unquote($navigation-child-selector)}) {
		#{string.unquote(custom-elements.$control-panel-brand)} {
			@include helpers.divider("bottom", "after");

			&::after {
				inset-block-end: calc(-1 * #{variables.$db-spacing-fixed-md});
			}
		}
	}

	&:has(
			#{string.unquote(custom-elements.$control-panel-brand)},
			#{string.unquote($navigation-child-selector)},
			#{string.unquote($meta-child-selector)}
		) {
		#{string.unquote(custom-elements.$control-primary-actions)} {
			padding-block-start: variables.$db-spacing-fixed-sm;

			@include helpers.divider("top");
		}
	}

	@include navigation-child {
		@include vertical-navigation;

		> menu {
			@include navigation-item.direct-navigation-items {
				@extend %db-puls;

				@include db-puls.set-db-puls-vertical();

				@include navigation-item.active-navigation-item {
					@include db-puls.show-db-puls-vertical();
				}

				@include navigation-item.direct-navigation-items {
					/* Workaround for custom-elements */
					&::after {
						content: none;
					}
				}
			}
		}
	}
}
