name: ðŸŽ­ Playwright E2E

on:
  workflow_call:
    inputs:
      version:
        required: true
        type: string
    outputs:
      has-failures:
        description: "Whether any of the component tests failed"
        value: ${{ jobs.check-results.outputs.has-failures }}

permissions:
  actions: write
  contents: write

jobs:
  playwright-ct:
    name: ðŸ§ªðŸŽ­ - ${{ matrix.framework }}:${{ matrix.shardIndex }}/${{ matrix.shardTotal }}
    runs-on: ubuntu-24.04 # Use Ubuntu 24.04 explicitly
    container:
      image: mcr.microsoft.com/playwright:v${{ inputs.version }}
      options: --user 1001
    strategy:
      fail-fast: false
      matrix:
        framework: [react, vue]
        shardIndex: [1, 2, 3]
        shardTotal: [3]
    steps:
      - name: â¬ Checkout repo
        uses: actions/checkout@v5

      - name: ðŸ”„ Init Cache
        uses: ./.github/actions/npm-cache

      - name: â¬ Download foundations build
        uses: actions/download-artifact@v5
        with:
          name: db-ux-foundations-build
          path: packages/foundations/build

      - name: â¬ Download output
        uses: actions/download-artifact@v5
        with:
          name: db-ux-output
          path: output

      - name: â¬ Download components styles build
        uses: actions/download-artifact@v5
        with:
          name: db-ux-components-build
          path: packages/components/build

      - name: ðŸš‹ Get working directory
        id: workingDirectory
        shell: bash
        run: echo "dir=${{ matrix.framework }}" >> $GITHUB_OUTPUT

      - name: ðŸ‘©â€ðŸ”¬ Test with Playwright ðŸŽ­
        working-directory: ./output/${{ steps.workingDirectory.outputs.dir }}
        run: npx playwright test --shard=${{ matrix.shardIndex }}/${{ matrix.shardTotal }}

      - name: ðŸ”£ Print GitHub Report
        if: failure()
        working-directory: ./output/${{ steps.workingDirectory.outputs.dir }}
        shell: bash
        run: |
          npx playwright merge-reports --reporter github ./blob-report

      - name: ðŸ†™ Upload test results
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.framework }}-components-playwright-results-${{ matrix.shardIndex }}
          path: ./output/${{ steps.workingDirectory.outputs.dir }}/test-results
          retention-days: 30

  check-results:
    if: always()
    needs: [playwright-ct]
    runs-on: ubuntu-24.04
    outputs:
      has-failures: ${{ steps.check.outputs.has-failures }}
    steps:
      - name: Check for failures
        id: check
        run: |
          if [[ "${{ contains(needs.playwright-ct.result, 'failure') }}" == "true" ]]; then
            echo "has-failures=true" >> $GITHUB_OUTPUT
            echo "Component tests have failures - will trigger snapshot regeneration"
          else
            echo "has-failures=false" >> $GITHUB_OUTPUT
            echo "All component tests passed"
          fi
