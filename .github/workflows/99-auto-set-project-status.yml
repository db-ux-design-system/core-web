---
name: üóø Auto set project status

permissions:
  pull-requests: write
  repository-projects: write

on:
  workflow_call:

jobs:
  set-status:
    runs-on: ubuntu-24.04
    if: ${{ github.actor != 'dependabot[bot]' }}
    steps:
      - name: üóø Set project status
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          ITEM_ID=$(gh project item-list 6 --owner db-ux-design-system --format json | jq -r --arg pr_url "${{ github.event.pull_request.html_url }}" '.items[] | select(.content.url == $pr_url) | .id')
          FIELD_ID=$(gh project field-list 6 --owner db-ux-design-system --format json | jq -r '.fields[] | select(.name == "Status") | .id')
          if [ "${{ github.event.action }}" = "review_requested" ]; then
            OPTION_ID=$(gh project field-list 6 --owner db-ux-design-system --format json | jq -r '.fields[] | select(.name == "Status") | .options[] | select(.name == "üëÄ Actively In Review") | .id')
            gh project item-edit --project-id 6 --id "$ITEM_ID" --field-id "$FIELD_ID" --single-select-option-id "$OPTION_ID"
          elif [ "${{ github.event.pull_request.draft }}" = "true" ]; then
            OPTION_ID=$(gh project field-list 6 --owner db-ux-design-system --format json | jq -r '.fields[] | select(.name == "Status") | .options[] | select(.name == "üèóÔ∏è In progress") | .id')
            gh project item-edit --project-id 6 --id "$ITEM_ID" --field-id "$FIELD_ID" --single-select-option-id "$OPTION_ID"
            gh pr edit "${{ github.event.pull_request.html_url }}" --remove-reviewer @*
          else
            OPTION_ID=$(gh project field-list 6 --owner db-ux-design-system --format json | jq -r '.fields[] | select(.name == "Status") | .options[] | select(.name == "üéÅ Ready for review") | .id')
            gh project item-edit --project-id 6 --id "$ITEM_ID" --field-id "$FIELD_ID" --single-select-option-id "$OPTION_ID"
          fi
        continue-on-error: true
