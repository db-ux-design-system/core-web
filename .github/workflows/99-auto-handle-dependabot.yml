---
name: Dependabot auto-handle

permissions:
  contents: write
  pull-requests: write

on:
  workflow_call:

jobs:
  dependabot:
    runs-on: ubuntu-24.04 # Use Ubuntu 24.04 explicitly
    if: ${{ github.actor == 'dependabot[bot]' }}
    steps:
      - name: ‚è¨ Dependabot metadata
        id: metadata
        uses: dependabot/fetch-metadata@v2
        with:
          github-token: "${{ secrets.GITHUB_TOKEN }}"

      - name: ‚úî Approve a PR
        if: ${{ steps.metadata.outputs.update-type == 'version-update:semver-patch' }}
        run: gh pr review --approve "$PR_URL"
        env:
          PR_URL: ${{github.event.pull_request.html_url}}
          GITHUB_TOKEN: ${{secrets.GITHUB_TOKEN}}

      - name: üêõ Debug update-type output
        run: echo "Update type is '${{ steps.metadata.outputs.update-type }}'"

      - name: üéÅ Set project status to Ready for review (non-patch PRs)
        if: ${{ steps.metadata.outputs.update-type != 'version-update:semver-patch' }}
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Setting project state for non-patch PR to 'üéÅ Ready for review'"

          # Get project data (assumes PR is already added to project by GitHub)
          PROJECT_DATA=$(gh project list --owner db-ux-design-system --format json --limit 1)
          PROJECT_NUMBER=$(echo "$PROJECT_DATA" | jq -r '.[0].number')
          PROJECT_ID=$(echo "$PROJECT_DATA" | jq -r '.[0].id')

          if [ -z "$PROJECT_NUMBER" ] || [ "$PROJECT_NUMBER" = "null" ]; then
            echo "Unable to find project"
            exit 0
          fi

          echo "Found project number: $PROJECT_NUMBER, ID: $PROJECT_ID"

          # Get the Status field and option IDs in one call
          FIELD_DATA=$(gh project field-list "$PROJECT_NUMBER" --owner db-ux-design-system --format json)
          FIELD_ID=$(echo "$FIELD_DATA" | jq -r '.fields[] | select(.name == "Status") | .id')
          OPTION_ID=$(echo "$FIELD_DATA" | jq -r '.fields[] | select(.name == "Status") | .options[] | select(.name == "üéÅ Ready for review") | .id')

          if [ -z "$FIELD_ID" ] || [ -z "$OPTION_ID" ] || [ "$FIELD_ID" = "null" ] || [ "$OPTION_ID" = "null" ]; then
            echo "Could not find Status field or 'üéÅ Ready for review' option"
            exit 0
          fi

          echo "Found Status field ID: $FIELD_ID"
          echo "Found option ID for 'üéÅ Ready for review': $OPTION_ID"

          # Get the item ID for this PR
          ITEM_ID=$(gh project item-list "$PROJECT_NUMBER" --owner db-ux-design-system --format json --limit 100 | jq -r --arg pr_url "${{ github.event.pull_request.html_url }}" '.items[] | select(.content.url == $pr_url) | .id')

          if [ -z "$ITEM_ID" ] || [ "$ITEM_ID" = "null" ]; then
            echo "PR not found in project"
            exit 0
          fi

          echo "Found item ID: $ITEM_ID"

          # Update the status field using gh project commands
          gh project item-edit --id "$ITEM_ID" --field-id "$FIELD_ID" --project-id "$PROJECT_ID" --single-select-option-id "$OPTION_ID"

          if [ $? -eq 0 ]; then
            echo "Successfully set project status to 'üéÅ Ready for review'"
          else
            echo "Failed to update project status"
          fi
        continue-on-error: true

      - name: ü§ñ Enable auto-merge for Dependabot PRs
        run: gh pr merge --auto --squash "$PR_URL"
        env:
          PR_URL: ${{github.event.pull_request.html_url}}
          GITHUB_TOKEN: ${{secrets.GITHUB_TOKEN}}
