name: Auto-Format with Stylelint and Prettier

on:
  workflow_call:

jobs:
  format:
    name: ðŸ†™ Auto-Format
    if: ${{ github.actor == 'dependabot[bot]' }}
    runs-on: ubuntu-24.04 # Use Ubuntu 24.04 explicitly
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: â¬ Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref }}

      - name: ðŸ” Check if Stylelint or Prettier update PR
        id: check_pr
        run: |
          echo "PR title: ${{ github.event.pull_request.title }}"
          if [[ "${{ github.event.pull_request.title }}" =~ "bump stylelint from" ]]; then
            echo "Stylelint update detected."
            echo "stylelint_update=true" >> $GITHUB_ENV
          elif [[ "${{ github.event.pull_request.title }}" =~ "bump prettier from" ]]; then
            echo "Prettier update detected."
            echo "prettier_update=true" >> $GITHUB_ENV
          else
            echo "No Stylelint or prettier updates detected."
          fi

      - name: ðŸ†™ Set up Node.js
        if: env.stylelint_update == 'true' || env.prettier_update == 'true'
        uses: actions/setup-node@v4
        with:
          node-version-file: ".nvmrc"

      - name: â¬ Install dependencies
        if: env.stylelint_update == 'true' || env.prettier_update == 'true'
        run: |
          npm ci

      - name: ðŸƒ Run Stylelint to format the code
        if: env.stylelint_update == 'true'
        run: |
          npm run build --workspace=@db-ux/core-stylelint
          npm run lint:stylelint -- --fix

      - name: ðŸƒ Run Prettier to format the code
        if: env.prettier_update == 'true'
        run: |
          npm run codestyle

      - name: ðŸš¦ Check for changes before committing
        id: check_changes
        run: |
          if [[ -z "$(git status --porcelain)" ]]; then
            echo "No changes to commit. Skipping auto-commit step."
            echo "changes_detected=false" >> $GITHUB_ENV
          else
            echo "Changes detected. Proceeding to auto-commit step."
            echo "changes_detected=true" >> $GITHUB_ENV

      - name: ðŸš˜ Auto commit
        if: steps.check_changes.outputs.changes_detected == 'true' && (env.stylelint_update == 'true' || env.prettier_update == 'true')
        uses: ./.github/actions/auto-commit
        with:
          branch-name: "${{ github.head_ref }}-auto"
          commit-message: "auto format code"
          commit-files: "."
          auto-merge-app-id: ${{ vars.AUTO_MERGE_APP_ID }}
          auto-merge-private-key: ${{ secrets.AUTO_MERGE_PRIVATE_KEY }}
          gh-token: ${{ secrets.GITHUB_TOKEN }}
